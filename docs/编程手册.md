# Deno Preact ISO 项目编程手册

## 1. 项目概述

Deno Preact ISO 是一个基于 Deno、Preact 和 Server-Side Rendering (SSR) 的全栈应用框架，采用插件化架构设计，支持模块化扩展和灵活部署。

## 2. 技术栈

### 2.1 核心技术

| 技术 | 版本 | 用途 | 溯源 |
|------|------|------|------|
| Deno | latest | 运行时 | `deno.json` |
| Preact | ^10.28.2 | 前端框架 | `server/deno.json` |
| Preact Signals | ^2.5.1 | 状态管理 | `server/deno.json` |
| Preact ISO | ^2.11.1 | SSR 支持 | `server/deno.json` |
| Hono | ^4.11.4 | Web 框架 | `server/deno.json` |
| ORPC | ^1.13.4 | RPC 框架 | `server/deno.json` |
| Zod | ^4.3.5 | 数据验证 | `server/deno.json` |
| Tailwind CSS | latest | 样式框架 | 项目配置 |
| Kysely | ^0.28.9 | SQL 查询构建器 | `server/deno.json` |
| LibSQL | ^0.5.22 | SQLite 数据库 | `server/deno.json` |
| MySQL2 | ^3.16.0 | MySQL 数据库 | `server/deno.json` |
| Class Variance Authority | ^0.7.1 | 组件变体管理 | `server/deno.json` |

### 2.2 目录结构

```
├── libs/           # 共享库
│   ├── build/      # 构建工具库
│   └── shadcn/     # UI 组件库
├── plugins/        # 插件系统
├── server/         # 主服务器
├── tests/          # 测试文件
└── docs/           # 文档
```

## 3. 编程风格指南

### 3.1 组件设计

**核心原则：拆分组件，避免大函数组件**

- ✅ **好的实践**：将功能拆分为多个小组件
- ❌ **避免**：在一个函数中编写大型组件

#### 组件拆分示例

```tsx
// ❌ 避免：单个大组件
function BigComponent() {
  return (
    <div>
      {/* 大量 JSX 代码... */}
    </div>
  );
}

// ✅ 推荐：拆分多个小组件
function ParentComponent() {
  return (
    <div>
      <Header />
      <Content />
      <Footer />
    </div>
  );
}

function Header() {
  return <header>Header Content</header>;
}

function Content() {
  return <main>Main Content</main>;
}

function Footer() {
  return <footer>Footer Content</footer>;
}
```

### 3.2 状态管理

**优先使用 Preact Signals**

- 使用 `useSignal` 创建响应式状态
- 避免过度使用复杂的状态管理库
- 状态应尽可能靠近使用它的组件

#### 状态管理示例

```tsx
import { useSignal } from "@preact/signals";

function Counter() {
  const count = useSignal(0);
  
  return (
    <div>
      <p>Count: {count.value}</p>
      <button onClick={() => count.value++}>Increment</button>
    </div>
  );
}
```

### 3.3 类型安全

**全面使用 TypeScript**

- 为所有组件和函数添加类型定义
- 使用 Zod 进行 API 验证
- 利用 Kysely 进行类型安全的数据库查询

#### 类型安全示例

```tsx
// 组件类型定义
interface ButtonProps {
  variant?: "primary" | "secondary";
  size?: "sm" | "md" | "lg";
  children: ReactNode;
}

function Button({ variant = "primary", size = "md", children }: ButtonProps) {
  // 组件实现
}
```

### 3.4 代码组织

**模块化设计**

- 每个功能模块应有清晰的职责
- 组件文件应放在 `components/` 目录
- 工具函数应放在 `utils/` 目录
- API 相关代码应放在 `api/` 目录

#### 目录结构示例

```
component/
├── Button/
│   ├── Button.tsx
│   └── index.ts
└── Card/
    ├── Card.tsx
    ├── CardHeader.tsx
    ├── CardContent.tsx
    └── index.ts
```

## 4. 项目架构

### 4.1 插件系统

项目采用插件化架构，允许通过插件扩展功能：

- 插件存放在 `plugins/` 目录
- 每个插件包含自己的配置、路由和组件
- 插件通过 `plugin.ts` 注册到主系统

#### 插件示例

```tsx
// plugins/my-plugin/plugin.ts
export function MyPlugin() {
  return {
    name: "my-plugin",
    routes: [
      // 插件路由
    ],
    components: {
      // 插件组件
    }
  };
}
```

### 4.2 API 设计

**使用 ORPC 进行 API 通信**

- API 定义在 `api/` 目录
- 使用 Zod 进行请求和响应验证
- 支持类型安全的客户端生成

#### API 定义示例

```tsx
// api/user.ts
import { z } from "zod";

export const userApi = {
  getUser: {
    input: z.object({ id: z.string() }),
    output: z.object({
      id: z.string(),
      name: z.string(),
      email: z.string().email()
    })
  }
};
```

### 4.3 数据库设计

**使用 Kysely 进行类型安全的数据库操作**

- 数据库类型定义在 `types/` 目录
- 支持多种数据库方言（LibSQL、MySQL）
- 提供数据库管理器统一接口

## 5. 开发流程

### 5.1 启动开发服务器

```bash
# 启动主服务器
deno task server

# 或者直接在 server 目录运行
deno run -A --unstable-raw-imports --unstable-bundle --watch server.tsx
```

### 5.2 构建和部署

```bash
# 构建客户端资源
deno task bundle

# 发布包
deno publish
```

### 5.3 测试

```bash
# 运行测试
deno test

# 特定测试文件
deno test tests/components/App.test.tsx
```

## 6. 组件开发

### 6.1 Shadcn 组件

项目使用自定义的 Shadcn UI 组件库，位于 `libs/shadcn/`：

- 组件遵循原子设计原则
- 支持主题定制
- 基于 Class Variance Authority 管理变体

#### 组件使用示例

```tsx
import { Button, Card, Input } from "@24wings/shadcn";

function MyComponent() {
  return (
    <Card>
      <Card.Header>
        <Card.Title>组件标题</Card.Title>
      </Card.Header>
      <Card.Content>
        <Input placeholder="输入内容" />
      </Card.Content>
      <Card.Footer>
        <Button>提交</Button>
      </Card.Footer>
    </Card>
  );
}
```

### 6.2 自定义组件

**创建新组件的步骤**：

1. 在 `components/` 目录创建组件文件夹
2. 编写组件实现
3. 导出组件
4. 更新主入口文件

## 7. 样式指南

### 7.1 Tailwind CSS

项目使用 Tailwind CSS 进行样式管理：

- 使用 `cn` 工具函数合并类名
- 遵循 Tailwind 最佳实践
- 支持主题定制

#### 样式示例

```tsx
import { cn } from "@24wings/shadcn/utils/cn.tsx";

function StyledComponent({ className }: { className?: string }) {
  return (
    <div 
      className={cn(
        "bg-card text-card-foreground rounded-lg shadow-md",
        className
      )}
    >
      Component content
    </div>
  );
}
```

### 7.2 主题系统

- 支持深色/浅色模式切换
- 支持多种颜色主题
- 主题配置通过 `ThemeContext` 管理

## 8. 调试技巧

### 8.1 Deno 调试

- 使用 VS Code 的 Deno 扩展
- 配置 `launch.json` 进行断点调试
- 使用 `console.log` 和 `Deno.inspect` 进行日志输出

### 8.2 常见问题

| 问题 | 解决方案 |
|------|----------|
| 模块未找到 | 检查导入路径，确保 `deno.json` 配置正确 |
| JSX 编译错误 | 检查 `compilerOptions.jsx` 配置 |
| 权限问题 | 使用 `-A` 标志或正确配置权限 |
| SSR 水合错误 | 确保客户端和服务端渲染结果一致 |

## 9. AI 代理使用指南

### 9.1 如何查找资料

1. **组件文档**：
   - 位置：`libs/shadcn/doc/`
   - 包含：所有 UI 组件的使用说明和 API 文档
   - 入口：`libs/shadcn/doc/INDEX.md`

2. **技术栈参考**：
   - 位置：`server/deno.json`
   - 包含：所有依赖的版本和用途

3. **架构设计**：
   - 位置：`docs/`
   - 包含：目录结构改进、组件设计等文档

4. **代码示例**：
   - 位置：`tests/`
   - 包含：各种组件和功能的测试示例

### 9.2 编码规范检查

- 组件应拆分到独立文件
- 使用 TypeScript 类型
- 优先使用 Preact Signals
- 遵循 Tailwind 样式规范
- 组件命名使用 PascalCase
- 文件命名使用  PascalCase

### 9.3 代码生成建议

1. **组件生成**：
   - 生成独立的组件文件
   - 包含完整的类型定义
   - 支持自定义类名

2. **API 生成**：
   - 使用 Zod 进行验证
   - 遵循 ORPC 规范
   - 包含输入输出类型

3. **样式生成**：
   - 使用 Tailwind CSS 类
   - 利用 `cn` 函数合并类名
   - 支持主题定制

## 10. 最佳实践

1. **组件设计**：
   - 拆分组件，避免大函数组件
   - 组件职责单一
   - 支持自定义样式
   - 包含完整的类型定义

2. **状态管理**：
   - 优先使用 Preact Signals
   - 状态靠近使用它的组件
   - 避免过度状态提升

3. **性能优化**：
   - 使用 memo 优化组件渲染
   - 懒加载非关键资源
   - 优化 SSR 渲染

4. **测试覆盖**：
   - 为组件编写单元测试
   - 测试关键业务逻辑
   - 定期运行测试套件

## 11. 版本控制

- 使用 Git 进行版本控制
- 遵循 Conventional Commits 规范
- 定期更新依赖
- 维护清晰的 CHANGELOG

## 12. 部署指南

- 支持多种部署方式
- 可以作为独立应用部署
- 支持容器化部署
- 支持边缘部署

## 13. 资源链接

- [Deno 文档](https://deno.land/manual)
- [Preact 文档](https://preactjs.com/guide)
- [Hono 文档](https://hono.dev/)
- [ORPC 文档](https://orpc.dev/)
- [Tailwind CSS 文档](https://tailwindcss.com/)

## 14. 总结

本手册提供了 Deno Preact ISO 项目的全面编程指南，涵盖了技术栈、架构设计、开发流程和最佳实践。AI 代理可以通过本手册快速了解项目结构和编码规范，提高开发效率和代码质量。

请在开发过程中严格遵循本手册的规范和建议，确保项目的可维护性和扩展性。