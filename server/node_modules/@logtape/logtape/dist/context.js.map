{"version":3,"file":"context.js","names":["categoryPrefixSymbol: unique symbol","context: Record<string, unknown>","callback: () => T","result: Record<string, unknown>","prefix: string | readonly string[]"],"sources":["../src/context.ts"],"sourcesContent":["import { LoggerImpl } from \"./logger.ts\";\n\n/**\n * Internal symbol for storing category prefix in context.\n */\nconst categoryPrefixSymbol: unique symbol = Symbol.for(\n  \"logtape.categoryPrefix\",\n) as typeof categoryPrefixSymbol;\n\n/**\n * A generic interface for a context-local storage.  It resembles\n * the {@link AsyncLocalStorage} API from Node.js.\n * @template T The type of the context-local store.\n * @since 0.7.0\n */\nexport interface ContextLocalStorage<T> {\n  /**\n   * Runs a callback with the given store as the context-local store.\n   * @param store The store to use as the context-local store.\n   * @param callback The callback to run.\n   * @returns The return value of the callback.\n   */\n  run<R>(store: T, callback: () => R): R;\n\n  /**\n   * Returns the current context-local store.\n   * @returns The current context-local store, or `undefined` if there is no\n   *          store.\n   */\n  getStore(): T | undefined;\n}\n\n/**\n * Runs a callback with the given implicit context.  Every single log record\n * in the callback will have the given context.\n *\n * If no `contextLocalStorage` is configured, this function does nothing and\n * just returns the return value of the callback.  It also logs a warning to\n * the `[\"logtape\", \"meta\"]` logger in this case.\n * @param context The context to inject.\n * @param callback The callback to run.\n * @returns The return value of the callback.\n * @since 0.7.0\n */\nexport function withContext<T>(\n  context: Record<string, unknown>,\n  callback: () => T,\n): T {\n  const rootLogger = LoggerImpl.getLogger();\n  if (rootLogger.contextLocalStorage == null) {\n    LoggerImpl.getLogger([\"logtape\", \"meta\"]).warn(\n      \"Context-local storage is not configured.  \" +\n        \"Specify contextLocalStorage option in the configure() function.\",\n    );\n    return callback();\n  }\n  const parentContext = rootLogger.contextLocalStorage.getStore() ?? {};\n  return rootLogger.contextLocalStorage.run(\n    { ...parentContext, ...context },\n    callback,\n  );\n}\n\n/**\n * Gets the current category prefix from context local storage.\n * @returns The current category prefix, or an empty array if not set.\n * @since 1.3.0\n */\nexport function getCategoryPrefix(): readonly string[] {\n  const rootLogger = LoggerImpl.getLogger();\n  const store = rootLogger.contextLocalStorage?.getStore();\n  if (store == null) return [];\n  const prefix = store[categoryPrefixSymbol as unknown as string];\n  return Array.isArray(prefix) ? prefix : [];\n}\n\n/**\n * Gets the current implicit context from context local storage, excluding\n * internal symbol keys (like category prefix).\n * @returns The current implicit context without internal symbol keys.\n * @since 1.3.0\n */\nexport function getImplicitContext(): Record<string, unknown> {\n  const rootLogger = LoggerImpl.getLogger();\n  const store = rootLogger.contextLocalStorage?.getStore();\n  if (store == null) return {};\n  // Filter out symbol keys (like categoryPrefixSymbol)\n  const result: Record<string, unknown> = {};\n  for (const key of Object.keys(store)) {\n    result[key] = store[key];\n  }\n  return result;\n}\n\n/**\n * Runs a callback with the given category prefix prepended to all log\n * categories within the callback context.\n *\n * This is useful for SDKs or libraries that want to add their own category\n * as a prefix to logs from their internal dependencies.\n *\n * If no `contextLocalStorage` is configured, this function does nothing and\n * just returns the return value of the callback.  It also logs a warning to\n * the `[\"logtape\", \"meta\"]` logger in this case.\n *\n * @example Basic usage\n * ```typescript\n * import { getLogger, withCategoryPrefix } from \"@logtape/logtape\";\n *\n * export function sdkFunction() {\n *   return withCategoryPrefix([\"my-sdk\"], () => {\n *     // Any logs from internal libraries within this context\n *     // will have [\"my-sdk\"] prepended to their category\n *     return internalLibraryFunction();\n *   });\n * }\n * ```\n *\n * @param prefix The category prefix to prepend.  Can be a string or an array\n *               of strings.\n * @param callback The callback to run.\n * @returns The return value of the callback.\n * @since 1.3.0\n */\nexport function withCategoryPrefix<T>(\n  prefix: string | readonly string[],\n  callback: () => T,\n): T {\n  const rootLogger = LoggerImpl.getLogger();\n  if (rootLogger.contextLocalStorage == null) {\n    LoggerImpl.getLogger([\"logtape\", \"meta\"]).warn(\n      \"Context-local storage is not configured.  \" +\n        \"Specify contextLocalStorage option in the configure() function.\",\n    );\n    return callback();\n  }\n  const parentContext = rootLogger.contextLocalStorage.getStore() ?? {};\n  const parentPrefix = getCategoryPrefix();\n  const newPrefix = typeof prefix === \"string\" ? [prefix] : [...prefix];\n  return rootLogger.contextLocalStorage.run(\n    {\n      ...parentContext,\n      [categoryPrefixSymbol as unknown as string]: [\n        ...parentPrefix,\n        ...newPrefix,\n      ],\n    },\n    callback,\n  );\n}\n"],"mappings":";;;;;;AAKA,MAAMA,uBAAsC,OAAO,IACjD,yBACD;;;;;;;;;;;;;AAqCD,SAAgB,YACdC,SACAC,UACG;CACH,MAAM,aAAa,WAAW,WAAW;AACzC,KAAI,WAAW,uBAAuB,MAAM;AAC1C,aAAW,UAAU,CAAC,WAAW,MAAO,EAAC,CAAC,KACxC,4GAED;AACD,SAAO,UAAU;CAClB;CACD,MAAM,gBAAgB,WAAW,oBAAoB,UAAU,IAAI,CAAE;AACrE,QAAO,WAAW,oBAAoB,IACpC;EAAE,GAAG;EAAe,GAAG;CAAS,GAChC,SACD;AACF;;;;;;AAOD,SAAgB,oBAAuC;CACrD,MAAM,aAAa,WAAW,WAAW;CACzC,MAAM,QAAQ,WAAW,qBAAqB,UAAU;AACxD,KAAI,SAAS,KAAM,QAAO,CAAE;CAC5B,MAAM,SAAS,MAAM;AACrB,QAAO,MAAM,QAAQ,OAAO,GAAG,SAAS,CAAE;AAC3C;;;;;;;AAQD,SAAgB,qBAA8C;CAC5D,MAAM,aAAa,WAAW,WAAW;CACzC,MAAM,QAAQ,WAAW,qBAAqB,UAAU;AACxD,KAAI,SAAS,KAAM,QAAO,CAAE;CAE5B,MAAMC,SAAkC,CAAE;AAC1C,MAAK,MAAM,OAAO,OAAO,KAAK,MAAM,CAClC,QAAO,OAAO,MAAM;AAEtB,QAAO;AACR;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAgCD,SAAgB,mBACdC,QACAF,UACG;CACH,MAAM,aAAa,WAAW,WAAW;AACzC,KAAI,WAAW,uBAAuB,MAAM;AAC1C,aAAW,UAAU,CAAC,WAAW,MAAO,EAAC,CAAC,KACxC,4GAED;AACD,SAAO,UAAU;CAClB;CACD,MAAM,gBAAgB,WAAW,oBAAoB,UAAU,IAAI,CAAE;CACrE,MAAM,eAAe,mBAAmB;CACxC,MAAM,mBAAmB,WAAW,WAAW,CAAC,MAAO,IAAG,CAAC,GAAG,MAAO;AACrE,QAAO,WAAW,oBAAoB,IACpC;EACE,GAAG;GACF,uBAA4C,CAC3C,GAAG,cACH,GAAG,SACJ;CACF,GACD,SACD;AACF"}