# 项目大纲：deno-preact-iso

## 1. 项目概述

这是一个基于 Deno + Preact + Hono 的插件化 Web 应用框架，支持服务端渲染 (SSR) 和客户端渲染，采用模块化设计，允许动态加载和管理插件。

## 2. 核心技术栈

| 技术 | 用途 | 版本 |
|------|------|------|
| Deno | 运行时环境 | 最新 |
| Preact | UI 框架 | ^10.28.2 |
| Preact-iso | SSR 支持 | ^2.11.1 |
| Hono | Web 框架 | ^4.11.4 |
| ORPC | API 通信 | ^1.13.4 |
| Tailwind CSS | 样式框架 | 最新 |
| shadcn/ui | UI 组件库 | 自定义 |
| Kysely | SQL 查询构建器 | ^0.28.9 |
| libsql | SQLite 数据库支持 | ^0.5.22 |
| mysql2 | MySQL 数据库支持 | ^3.16.0 |
| Zod | 类型验证 | ^4.3.5 |

## 3. 项目结构

```
e:\deno-code\deno-preact-iso/
├── .vscode/              # VSCode 配置
├── docs/                 # 项目文档和笔记
├── libs/                 # 核心库
│   ├── build/            # 构建和模块管理
│   └── shadcn/           # UI 组件库
├── plugins/              # 插件目录
│   ├── admin/            # 管理后台插件
│   └── shopxo/           # ShopXO 插件
├── server/               # 主服务器
├── .gitignore            # Git 忽略文件
├── deno-preact-iso.rar   # 项目压缩包
├── deno.jsonc            # 项目配置
├── deno.lock             # 依赖锁定文件
└── tailwind.config.js    # Tailwind 配置
```

## 4. 核心功能模块

### 4.1 模块管理系统

**功能**：负责插件的加载、安装和管理

**核心组件**：
- `ModuleManager` 类 (`libs/build/module-manager.ts`)
  - 安装和管理模块
  - 处理请求路由
  - 管理默认模块

**工作流程**：
1. 服务器启动时加载默认模块
2. 根据配置或命令行参数加载其他插件
3. 请求到达时，根据路径匹配到对应的模块处理
4. 支持动态安装和卸载模块

### 4.2 ORPC API 系统

**功能**：提供 API 通信机制

**核心组件**：
- `orpc_handle` 函数 (`libs/build/orpc.ts`)
- `orpc_router` 函数 (`libs/build/orpc.ts`)
- `setup_openapi` 函数 (`libs/build/orpc.ts`)
- `orpc_scalar_html` 函数 (`libs/build/orpc.ts`)：提供 API 文档页面

**特性**：
- 基于 ORPC 协议
- 自动生成 OpenAPI 文档
- 支持 Scalar API 参考页面
- 支持上下文传递

### 4.3 数据库管理系统

**功能**：提供数据库连接和管理

**核心组件**：
- `db_manager` (`server/db/mod.tsx`)

**特性**：
- 支持多种数据库 (SQLite, MySQL)
- 基于 Kysely 查询构建器
- 支持事务管理
- 支持数据库迁移

### 4.4 UI 组件库

**功能**：提供预构建的 UI 组件

**核心组件**：
- 基础组件 (`libs/shadcn/components/`)
  - Accordion, Alert, Badge, Button, Card 等
- 高级组件 (`libs/shadcn/pro/components/`)
  - ProTable 等
- 布局组件 (`libs/shadcn/pro/layouts/`)
  - AppBreadcrumb, AppNavbar, AppSidebar 等

**特性**：
- 基于 shadcn/ui
- 支持主题切换
- 响应式设计
- 可定制化

### 4.5 服务端渲染

**功能**：支持服务端渲染

**核心组件**：
- `ssr-loader.tsx` (`libs/build/ssr-loader.tsx`)
- Preact-iso 库

**特性**：
- 支持服务端渲染和客户端渲染
- 支持 Hydration
- 支持路由级别的 SSR

## 5. 插件系统

### 5.1 插件结构

每个插件包含：
- `plugin.ts`：插件入口
- `api/`：API 定义
- `app/`：前端应用
- `routes/`：路由定义
- `deno.json`：插件配置

### 5.2 现有插件

#### 5.2.1 Admin 插件

**功能**：提供管理后台

**结构**：
- `api/`：管理 API
- `app/`：管理后台前端
- `routes/`：管理后台路由

#### 5.2.2 ShopXO 插件

**功能**：提供 ShopXO 电商平台集成

**结构**：
- `supplier/`：供应商管理
- `src/`：插件源码

## 6. 运行机制

### 6.1 服务器启动流程

1. 加载环境变量
2. 初始化数据库连接
3. 加载默认模块
4. 加载激活的插件
5. 设置请求处理路由
6. 启动 HTTP 服务器

### 6.2 请求处理流程

1. 请求到达主服务器
2. 根据路径匹配到对应的模块
3. 模块处理请求
4. 返回响应

### 6.3 插件加载流程

1. 读取插件配置
2. 动态导入插件模块
3. 注册插件路由
4. 添加到模块列表

## 7. 配置和部署

### 7.1 配置文件

- `deno.jsonc`：主项目配置
- `server/deno.json`：服务器配置
- `tailwind.config.js`：Tailwind 配置

### 7.2 命令行参数

- `-m`：设置默认模块
- `-d`：禁用其他模块
- `--help`：显示帮助信息

### 7.3 部署方式

使用 Deno 任务系统进行部署：
```bash
deno task server
```

## 8. 开发流程

### 8.1 开发环境设置

1. 安装 Deno
2. 克隆项目
3. 运行开发服务器

### 8.2 插件开发

1. 创建插件目录
2. 编写插件入口文件
3. 定义 API 和路由
4. 开发前端应用
5. 测试插件

## 9. 技术亮点

1. **插件化架构**：支持动态加载和管理插件，便于扩展
2. **服务端渲染**：提供良好的首屏性能和 SEO 支持
3. **ORPC API**：简化 API 开发和文档生成
4. **多数据库支持**：支持 SQLite 和 MySQL
5. **现代化技术栈**：使用 Deno、Preact、Hono 等现代技术
6. **完整的 UI 组件库**：提供丰富的预构建 UI 组件
7. **模块化设计**：便于维护和扩展

## 10. 未来发展方向

1. 支持更多数据库类型
2. 提供更多预构建插件
3. 完善文档和示例
4. 优化性能
5. 增强安全性
6. 支持更多部署方式

## 11. 总结

Deno-Preact-ISO 是一个现代化的插件化 Web 应用框架，具有以下特点：

- **现代化技术栈**：基于 Deno、Preact、Hono 等现代技术
- **插件化架构**：支持动态加载和管理插件
- **服务端渲染**：提供良好的首屏性能和 SEO 支持
- **完整的 UI 组件库**：提供丰富的预构建 UI 组件
- **多数据库支持**：支持多种数据库
- **ORPC API**：简化 API 开发和文档生成

该框架适用于构建各种 Web 应用，特别是需要插件化架构、服务端渲染和现代化技术栈的应用。